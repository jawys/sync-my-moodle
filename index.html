<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="index.css" type="text/css">
</head>

<body>
  <fieldset>
    <legend>Anmeldedaten</legend>
    <input type="text" id="username" placeholder="Benutzername">
    <input type="password" id="password" placeholder="Passwort">
    <button id="save-credentials">Speichern</button>
    <button id="update-courses">Kursliste aktualisieren</button>
  </fieldset>
  <p></p>
  <fieldset>
    <legend>Kursliste</legend>
    <div id="courses"></div>
  </fieldset>
  <p>
    <button id="select-directory">Speicherverzeichnis wählen</button>
    <span id="selected-directory"></span>
    <button id="download" hidden>Download</button>
  </p>
</body>

<script>
  // Import the ipc module for the renderer process
  const ipc = require('electron').ipcRenderer

  // Get the UI buttons
  const saveBtn = document.getElementById('save-credentials')
  const coursesBtn = document.getElementById('update-courses')
  const selectDirBtn = document.getElementById('select-directory')
  const downloadBtn = document.getElementById('download')

  // Add EventListeners to the buttons
  saveBtn.addEventListener('click', () => {
    const username = document.getElementById('username').value
    const password = document.getElementById('password').value
    const credentials = {
      username: username,
      password: password
    }
    ipc.send('save-credentials', credentials)
  })
  coursesBtn.addEventListener('click', () => {
    ipc.send('update-courses')
  })
  selectDirBtn.addEventListener('click', () => {
    ipc.send('open-save-dialog')
  })

  // Update courses in UI after receiving them
  ipc.on('courses-updated', (event, courses) => {
    console.log('courses:', courses)
    const divCourses = document.getElementById('courses')

    for (const course of courses) {
      const idCourse = `course-${course.id}`
      let detailsCourse = document.getElementById(idCourse)

      if (detailsCourse === null) {
        detailsCourse = document.createElement('details')
        const summaryCourse = document.createElement('summary')
        const checkboxCourse = document.createElement('input')
        const spanCourse = document.createElement('span')
        const ddCourse = document.createElement('dd')

        detailsCourse.id = idCourse
        checkboxCourse.type = 'checkbox'
        spanCourse.innerText = course.title

        divCourses.appendChild(detailsCourse)
        detailsCourse.appendChild(summaryCourse)
        summaryCourse.appendChild(checkboxCourse)
        summaryCourse.appendChild(spanCourse)
        detailsCourse.appendChild(ddCourse)

        checkboxCourse.onclick = function updateChildCheckboxes () {
          const checkState = this.checked
          for (const checkbox of ddCourse.querySelectorAll('input[type=checkbox]')) {
            checkbox.checked = checkState
          }
        }
      }

      const ddCourse = detailsCourse.lastChild

      if (course.resources === undefined) {
        ddCourse.innerText = 'lädt…'
      } else if (course.resources.length === 0) {
        ddCourse.innerText = '(leer)'
      } else {
        ddCourse.innerText = ''
        for (const resource of course.resources) {
          const summaryResource = document.createElement('summary')
          const checkboxResource = document.createElement('input')
          const spanResource = document.createElement('span')

          summaryResource.id = `resource-${resource.id}`
          checkboxResource.type = 'checkbox'
          spanResource.innerText = resource.title

          ddCourse.appendChild(summaryResource)
          summaryResource.appendChild(checkboxResource)
          summaryResource.appendChild(spanResource)

          checkboxResource.onclick = function updateParentCheckbox () {
            let checkState = this.checked
            for (const checkbox of ddCourse.querySelectorAll('input[type=checkbox]')) {
              if (checkState !== checkbox.checked) {
                checkState = false
              }
            }
            detailsCourse.querySelector('input').checked = checkState
          }
        }
      }
    }
  })

  // Show selected directory
  ipc.on('selected-directory', function (event, path) {
    selectDirBtn.hidden = true
    downloadBtn.hidden = false
    document.getElementById('selected-directory').innerText = `Speicherverzeichnis: ${path}`
  })
</script>

</html>
