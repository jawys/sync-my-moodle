<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
  <meta name="viewport" content="width=device-width" />


  <!-- Bootstrap core CSS     -->
  <link href="assets/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Animation library for notifications   -->
  <link href="assets/css/animate.min.css" rel="stylesheet"/>

  <!--  Light Bootstrap Table core CSS    -->
  <link href="assets/css/light-bootstrap-dashboard.css" rel="stylesheet"/>

  <!--     Fonts and icons     -->
  <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300' rel='stylesheet' type='text/css'>
  <link href="assets/css/pe-icon-7-stroke.css" rel="stylesheet" />

  <link rel="stylesheet" href="assets/css/main.css">
  <!--  <link rel="stylesheet" href="index.css" type="text/css">-->
</head>

<body>
<fieldset>
  <div class="content">
    <!-- Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">Anmelden</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <!--Modal Content-->
          <div class="modal-body">
            <label for="username">Benutzername:</label>
            <input type="text" class="form-control" id="username" placeholder="123456@students.hsrw">
            <label for="password">Passwort:</label>
            <input type="password" class="form-control" id="password" placeholder="Passwort">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>
            <button type="button" class="btn btn-primary" id="save-credentials">Speichern</button>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div class="row">
        <div class="card ">
          <div class="header">
            <h4 class="title"><i class="fa fa-list-alt" aria-hidden="true"></i> Kursliste</h4>
            <!--<p class="category">[Name Des Nutzers]</p>-->
          </div>
          <div class="content" >

           <div id="courses"></div>

            <div class="footer">
              <hr>
              <div class="stats">
                <i class="fa fa-history"></i> Updated 3 minutes ago
              </div>
            </div>
            <button id="update-courses" class="btn  float-left"><i class="fa fa-refresh"></i>Kursliste aktualisieren</button>
            <button id="select-directory" class="btn btn-primary-outline float-right"><i class="fa fa-folder"></i>Speicherverzeichnis wählen</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</fieldset>
<p>
  <span id="selected-directory"></span>
  <button id="download" class="btn btn-primary-outline btn-lg" hidden>Download</button>
</p>
<!-- Insert this line above script imports  -->
<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>

<!--   Core JS Files   -->
<script src="assets/js/jquery-1.10.2.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="assets/js/bootstrap.min.js" type="text/javascript"></script>
<!--  Checkbox, Radio & Switch Plugins -->
<script src="assets/js/bootstrap-checkbox-radio-switch.js"></script>
<script src="assets/js/bootstrap-notify.js"></script>
<!-- Insert this line after script imports -->
<script>if (window.module) module = window.module;</script>
</body>

<script>
    // Import the ipc module for the renderer process
    const ipc = require('electron').ipcRenderer

    // Get the UI buttons
    const saveBtn = document.getElementById('save-credentials')
    const coursesBtn = document.getElementById('update-courses')
    const selectDirBtn = document.getElementById('select-directory')
    const downloadBtn = document.getElementById('download')

    // Add EventListeners to the buttons
    saveBtn.addEventListener('click', () => {
        const username = document.getElementById('username').value
        const password = document.getElementById('password').value
        const credentials = {
            username: username,
            password: password
        }
        ipc.send('save-credentials', credentials)
    })

    coursesBtn.addEventListener('click', () => {
        ipc.send('update-courses')
    })

    selectDirBtn.addEventListener('click', () => {
        ipc.send('open-save-dialog')
    })

    downloadBtn.addEventListener('click', () => {
        for (let checkbox of courses.querySelectorAll('[data-resource-id] :checked')) {
        ipc.send('download-resource', checkbox.parentElement.dataset.resourceId)
    }
    })

    // Update courses in UI after receiving them
    ipc.on('courses-updated', (event, courses) => {
        console.log('courses:', courses)
    const coursesDiv = document.querySelector('#courses')

    for (const course of courses) {
        let courseElem = coursesDiv.querySelector(`[data-course-id="${course.id}"]`)

        if (courseElem === null) {
            courseElem = document.createElement('details')
            $(courseElem).addClass("p-1")
            const summary = document.createElement('summary')
            const labelCb =  document.createElement('label')
            const checkbox = document.createElement('input')
            const span = document.createElement('span')
            const dd = document.createElement('dd')
            $(dd).addClass('p-1')
            courseElem.dataset.courseId = course.id
            checkbox.type = 'checkbox'
            span.innerText = course.title

            $(summary).css('display', 'flex')
            $(labelCb).addClass('checkbox')
            $(labelCb).html("<span class='icons'><span class='first-icon fa fa-square-o'></span><span class='second-icon fa fa-check-square-o'></span></span><span class='icons'><span class='first-icon fa fa-square-o'></span><span class='second-icon fa fa-check-square-o'></span></span>")
            labelCb.appendChild(checkbox)
            coursesDiv.appendChild(courseElem)
            courseElem.appendChild(summary)
            summary.appendChild(labelCb)
            summary.appendChild(span)
            courseElem.appendChild(dd)

            checkbox.addEventListener('click', function updateChildCheckboxes () {
                const checkState = this.checked
                for (const checkbox of dd.querySelectorAll('[type=checkbox]')) {
                    checkbox.checked = checkState
                }
            })
        }
        // Reserve last child of course element for resources
        const resourcesElem = courseElem.lastChild

        if (course.resources === undefined) {
            resourcesElem.innerHTML = '<i class="fa fa-circle-o-notch fa-spin fa-fw"></i> lädt…'
        } else if (course.resources.length === 0) {
            resourcesElem.innerHTML = '<i class="fa fa-meh-o" aria-hidden="true"></i> (leer)'
        } else {
            resourcesElem.innerText = ''
            for (const resource of course.resources) {
                const summary = document.createElement('summary')
                const labelCb =  document.createElement('label')
                const checkbox = document.createElement('input')

                $(summary).css('display', 'flex')
                $(labelCb).addClass('checkbox')
                $(labelCb).html("<span class='icons'><span class='first-icon fa fa-square-o'></span><span class='second-icon fa fa-check-square-o'></span></span><span class='icons'><span class='first-icon fa fa-square-o'></span><span class='second-icon fa fa-check-square-o'></span></span>")

                labelCb.appendChild(checkbox)
                const span = document.createElement('span')

                summary.dataset.resourceId = resource.id
                checkbox.type = 'checkbox'
                span.innerText = resource.title

                resourcesElem.appendChild(summary)
                summary.appendChild(labelCb)
                summary.appendChild(span)

                checkbox.addEventListener('click', function updateParentCheckbox () {
                    let checkState = this.checked
                    for (const checkbox of resourcesElem.querySelectorAll('[type=checkbox]')) {
                        if (checkState !== checkbox.checked) {
                            checkState = false
                        }
                    }
                    courseElem.querySelector('[type=checkbox]').checked = checkState
                })
            }
        }
    }
    }
    )

    // Show selected directory
    ipc.on('selected-directory', (event, path) => {
        selectDirBtn.hidden = true
    downloadBtn.hidden = false
    document.getElementById('selected-directory').innerText = `Speicherverzeichnis: ${path}`
    })

    // Toggle loginModal on load
    $(function() {
      $("#loginModal").modal('toggle');
      $("#loginModal").on('hidden.bs.modal', function (e) {
          // Toggle Success
          $.notify({
              // options
              icon: 'fa fa-check',
              message: 'Erfolgreich angemeldet'
          },{
              // settings
              type: 'success',
              placement: {
                  from: "top",
                  align: "center"
              }
          });
      })
  })
</script>

</html>
